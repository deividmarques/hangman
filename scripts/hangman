#!/bin/bash

# The first arg provided here will be used as command option
COMMAND=$1

case $COMMAND in
  setup)
    # Ensure that UID variable exists and is exported
    export UID

    printf "Creating containers... "
    if ! [$(docker-compose build &> /dev/null)]; then
      printf "Error while building your image... Run docker-compose build manually"
      exit 1
    fi

    printf "Created!\n"

    printf "Running mix deps.get to configure project dependencies... "
    docker-compose run \
      --entrypoint '/bin/sh -c' api 'mix deps.get' &> /dev/null
    printf "Done!\n"
    
    printf "Building api assets with npm... "
    docker-compose run \
      --entrypoint '/bin/sh -c' api 'cd ./assets && npm install' &> /dev/null
    printf "Done!\n"

    printf "Installing frontend dependencies... "
    docker-compose run \
      --entrypoint '/bin/sh -c' frontend 'yarn install'
    printf "Done!\n"

    printf "Finished! \\o/"
  ;;

  db:create)
    echo "Preparing database... "
    docker-compose run \
      --entrypoint '/bin/sh -c' api 'mix ecto.create'
    echo "Done"
  ;;

  start)
    docker-compose up
  ;;

  phx:console)
    docker-compose run \
      --entrypoint '/bin/sh -c' api 'iex -S mix phx.server'
  ;;

  npm:console)
    docker-compose run \
      --entrypoint '/bin/sh' frontend
  ;;

  # Default option, display help information
  *)
    echo "Invalid option. The allowed ones are:"
    echo "setup          - Setup the hangman project"
    echo "start          - Start the hangman project (must run setup first!)"
    echo "db:create      - Create the hangman database"
    echo "phx:console    - Run the hangman console"
  ;;
esac
